<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Moje Zajęcia Praktyczne</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <a href="info.html" id="nav-info">Info</a>
    <a href="zajecia_praktyczne.html" id="nav-zajecia">Zajęcia praktyczne</a>
    <a href="planowanie.html" id="nav-plan">Plan Jazd</a>
    <a href="index.html" onclick="sessionStorage.clear();">Wyloguj</a>
  </nav>

  <div class="container">
    <h1 id="page-title">Moje Zajęcia Praktyczne</h1>
    
    <div id="student-schedule-view">
      <p style="text-align: center; margin-bottom: 20px;">Witaj <span id="student-name"></span>! Tutaj znajdziesz listę swoich zaplanowanych jazd.</p>
      
      <h2>Twoje zaplanowane jazdy:</h2>
      <div id="student-schedule-table-container">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Godzina Od</th>
              <th>Godzina Do</th>
              <th>Instruktor</th>
              <th>Pojazd</th>
              <th>Status</th>
              <th>Akcja</th> 
            </tr>
          </thead>
          <tbody id="student-schedule-tbody">
            <tr><td colspan="7">Ładowanie harmonogramu...</td></tr> 
          </tbody>
        </table>
      </div>
    </div>

    <div id="unauthorized-view-student" style="display: none;">
        <p style="text-align: center; color: red;">Ta sekcja jest dostępna tylko dla zalogowanych uczniów.</p>
        <p style="text-align: center;">Jeśli jesteś instruktorem, przejdź do <a href="planowanie.html">Planu Jazd</a>.</p>
        <p style="text-align: center;">Jeśli nie jesteś zalogowany, przejdź do <a href="index.html">strony logowania</a>.</p>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const userId = sessionStorage.getItem('userId');
      const userRole = sessionStorage.getItem('userRole');
      const userName = sessionStorage.getItem('userName');

      const studentView = document.getElementById('student-schedule-view');
      const unauthorizedView = document.getElementById('unauthorized-view-student');
      const pageTitle = document.getElementById('page-title');

      if (userId && userRole && userName) {
        if (userRole === 'Uczniem') {
          pageTitle.textContent = 'Moje Zajęcia Praktyczne';
          document.getElementById('student-name').textContent = userName;
          studentView.style.display = 'block';
          loadStudentSchedule(userId);
        } else {
          studentView.style.display = 'none';
          unauthorizedView.style.display = 'block';
        }
      } else {
           studentView.style.display = 'none';
         unauthorizedView.style.display = 'block';
      }
    });

    async function loadStudentSchedule(studentId) {
      const tbody = document.getElementById('student-schedule-tbody');
      tbody.innerHTML = '<tr><td colspan="7">Ładowanie harmonogramu...</td></tr>';

      try {
        const response = await fetch('get_student_schedule.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ student_id: studentId })
        });

        if (!response.ok) {
          throw new Error(`Błąd serwera: ${response.status}`);
        }

        const schedule = await response.json();

        if (schedule.status === 'success' && Array.isArray(schedule.data)) {
          tbody.innerHTML = ''; 
          if (schedule.data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7">Nie masz jeszcze żadnych zaplanowanych jazd.</td></tr>';
          } else {
            schedule.data.forEach(ride => {
              const row = tbody.insertRow();
              const isPast = new Date(ride.data_jazdy + 'T' + ride.godzina_od) < new Date();
              const cancelButton = (ride.odbyta || isPast) 
                ? '' 
                : `<button class="cancel-button" onclick="confirmCancel(${ride.jazda_id}, this)">Odwołaj</button>`;

              row.innerHTML = `
                <td>${ride.data_jazdy}</td>
                <td>${ride.godzina_od.substring(0, 5)}</td>
                <td>${ride.godzina_do.substring(0, 5)}</td>
                <td>${ride.instruktor_imie} ${ride.instruktor_nazwisko}</td>
                <td>${ride.pojazd_rejestracja || '-'}</td>
                <td>${ride.odbyta ? 'Odbyta' : 'Zaplanowana'}</td>
                <td>${cancelButton}</td>
              `;
            });
          }
        } else {
           tbody.innerHTML = `<tr><td colspan="7">Błąd podczas ładowania harmonogramu: ${schedule.message || 'Nieznany błąd'}</td></tr>`;
           console.error("Server response error:", schedule.message);
        }
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="7">Błąd połączenia lub przetwarzania: ${error.message}</td></tr>`;
        console.error('Error fetching student schedule:', error);
      }
    }

    async function confirmCancel(rideId, button) {
      if (confirm("Czy na pewno chcesz odwołać tę jazdę?")) {
        console.log(`Wysyłanie żądania odwołania jazdy o ID: ${rideId}`);
        let row = button.closest('tr');
        row.remove();
        alert("Jazda została odwołana (symulacja).");
      }
    }

  </script>

</body>
</html>
